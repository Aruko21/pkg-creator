# Задание производственной практики АСЭ
## Утилита формирования debian-пакета сервиса ASP.NET Core C\#

### ТЗ:
Разработать утилиту формирования debian-пакета, с возможностью кастомизации установочных
скриптов и описания пакета.

**Входные данные** - каталог с файлами будущего пакета

### Описание
Разработанная утилита **pkg-creator** представляет собой набор **bash**- и **python**-скриптов, формирующих
на основе пользовательских данных debian-пакет для последующей дистрибьюции и установки.

### Требования к структуре пакета
Директория пакета, который будет запакован в debian-пакет утилитой **pkg-creator** в минимальном
варианте может содержать только пользовательские файлы, которые будут распакованы в процессе
инсталляции пакета.

В таком случае, в ходе работы утилиты, пользователю будет предложено ввести данные о пакете:
название, папка установки, данные о владельце и т.д.

Также пользователь может создать папку `PKGINFO` **в корне директории пакета**.
Данная папка содержит информацию для установки пакета, которая может включать в себя следующие
файлы:
- `package-info` - переопределение параметров пакета по умолчанию (см. приложение 1)
- `scripts` - описание функций для расширения MAINTAINER скриптов (см. приложение 2)
- `questions.json` - описание шаблонов пользовательских вопросов при инсталляции (см. приложение 2)
- `LICENSE` - лицензия пакета, которая будет выводится пользователю при инсталляции и с предложением принять соглашение

Минимальным требованием к директории пакета является наличие хотя бы одного файла или папки в директории
пакета (за исключением PKGINFO) или наличие определения функции `postinst` в файле `scripts`
(см. приложение 2)

### Тестовые пример
В репозитории содержится 2 тестовых примера в директории `examples`.\
Пакет `string-input-pacc`:\
*Инсталляция данного пакета представляет собой следующий сценарий:*
- Пользователю отображается лицензионное соглашение с предложением принять его или отказаться.
- В случае отказа инсталляция завершается. Иначе пользователю отображается приветственное сообщение с предложением
  ввести свое имя
- Далее пользователю предлагается ввести пароль для доступа к дополнительному функционалу установки.
- В случае верного пароля (`secret`) - пользователю будет предложено ввести строку, которая будет сохранена
в файле `mystring.txt` в директории установленного пакета - `/opt/string-input-pack`
- В случае неверного ответа - пользователю выводится соответствующее сообщение, а в файл `mystring.txt` записывается
  стандартная строка
  
При реконфигурации пакета, в данный файл будет дописана новая строка.

Пакет `ase-prac-service`:
- Данный пакет представляет собой демонстрационный сервис C# ASP.NET, реализующий калькулятор.
- После установки данного пакета, пользователь может:
  - `service ase-prac-service start` - запустить сервис
  - `service ase-prac-service stop` - остановить сервис
  - `service ase-prac-service status` - посмотреть информацию о статусе сервиса.

Сервис работает по адресу: `localhost:5000`

Данные тестовый пример направлены на демонстрацию возможностей утилиты, а именно - формирование
файла-конфигурации `package.info`, использование API утилиты для формироваия сценария пользовательских
вопросов и расшширение скриптов этапов инсталляции - файл `scripts`, формирование собственных вопросов -
файл `questions.json`.

### Команды и установка:
Установка утилиты **pkg-creator** осуществляется 2-мя возможными способами:
- Посредством скачивания исходных файлов и запуска скрипта `install.sh` с
  предварительной установкой прав через `sudo`:
  - `sudo ./install.sh` - установка символьной ссылки для утилиты **pkg-creator**
  - `sudo ./uninstall.sh` - удаление символьной ссылки
- Посредством установки предварительно сформированного debian-пакета `pkg-creator_*.deb`:
  - `sudo dpkg -i pkg-creator_*.deb` - установка пакета `pkg-creator`
  - `sudo apt remove --purge pkg-creator` - удаление пакета `pkg-creator`

Команды для сборки пакета:
- `pkg_creator <путь_к_директории_пакета>` - создание пакета <имя_пакета>.deb
- `sudo dpkg -i <имя_пакета>.deb` - установка debian-пакета
- `sudo dpkg-reconfigure <имя_пакета>.deb` - перенастройка debian-пакета
- `sudo apt remove --purge <имя_пакета>.deb` - удаление debian-пакета и данных пакета debconf

## Приложение 1
Данное приожение описывает конфигурационные переменные пакета.

Утилита использует конфигурационный файл по-умолчанию: `pkg-creator.cfg`, в котором описаны все
возможные для использования и переопределения переменные:
- `PKG_NAME` - имя пакета
- `PKG_VERSION` - версия пакета
- `PKG_ARCH` - архитектура для пакета
- `PKG_SECTION` - область применения пакета
- `PKG_DEPENDS` - зависимости, трубемые для работы пакета
- `MAINTAINER_NAME` - имя владельца
- `MAINTAINER_EMAIL` - эл. почта владельца
- `ENDPOINT_DIR` - папка установки
- `INCLUDES` - bash-массив с указанием файлов для запаковки

**примечание**
bash-массив `INCLUDES` имеет следующий формат: `("dir1/" "dir2/" "file1")` - строковые обозначения
файлов и директорий разделяются **пробелами**.\
Причем  также возможно указание `INCLUDES=("./")`, что будет обозначать запаковку всех данных в
директории пакета в debian-пакет (за исключением папки `PKGINFO`) 

## Приложение 2
Данное приожение описывает API утилиты к расширению MAINTAINER-скриптов пакета.

MAINTAINER-скрипты включают в себя:   

- `preinst` - скрипт, выполняющийся перед распаковкой данных пакета 
- `postinst` - скрипт, выполняющийся после распаковки данных пакета
- `prerm` - скрипт, выполняющийся перед удалением данных пакета
- `postrm` - скрипт, выполняющийся после удаления данных пакета

При желании добавить пользовательский функионал для данных скриптов, пользователю предоставляется
возможность описать в файле `PKGINFO/scripts` функции с одноименным названием одного из 4-х скриптов выше.
Данные функции будут имплантированы в основной скрипт и вызваны.

Также, пользователь может расширить стандартные вопросы при инсталляции путем определения
шаблонов вопросов в файле `questions` в соответствии с форматом debconf templates - 
https://www.debian.org/doc/packaging-manuals/debconf_specification.html

(В будущем планируется использовать json)

Сценарий задания вопросов описывается в функции `config` внутри файла `PKGINFO/scripts`.
Данный сценарий должен использовать API, предоставляемый утилитой, описанный в приложении 3.

**примечание**\
Во всех функциях, а также в файле `questions` можно использовать **шаблоны** вида: `{{ VARIABLE }}`
Данный функционал позволяет ссылаться на глобальные переменные конфигурации пакета и, например,
в файле `questons` использовать в качестве имени вопроса следующую запись: `Template: {{ PKG_NAME }}/greeting`

*Шаблонизирование происходит путем подстановки значений глобальных переменных bash одноименным шаблонам*

## Приложение 3
Данное приожение описывает API утилиты к взаимодействию с пользовательскии вопросами.
(Задание вопроса, получение ответа).

В файле `PKGINFO/scripts` пользователь должен использовать данное API вместо прямого вызова
команд `debconf`

Функционал:
- `ask_question <идентефикатор вопроса>` - вывод вопроса пользователю 
- `get_answer <идентефикатор вопроса>` - получение ответа на вопрос (доступен по переменной `$RET`)
- `set_window_title <сообщение>` - установка заголовка окна вопроса
- `cancel_install` - прерывание инсталляции и очистка данных

**примечание**\
`<идентефикатор вопроса>` соответствует ключу `Template` в шаблоне вопроса.